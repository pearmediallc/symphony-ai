<!-- static/avatar.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TikTok Digital Avatar - Speaking Videos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #FF004F;
      --secondary: #00F2EA;
      --dark: #161823;
      --light: #FFFFFF;
      --gray: #F7F7F8;
      --text-gray: #545454;
      --border: #E1E1E2;
      --success: #10b981;
      --warning: #eab308;
      --danger: #dc2626;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }

    .nav-header {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 16px 0;
      margin-bottom: 32px;
    }

    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--dark);
    }

    .nav-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
    }

    .nav-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .nav-links {
      display: flex;
      gap: 24px;
    }

    .nav-link {
      text-decoration: none;
      color: var(--text-gray);
      font-weight: 500;
      transition: color 0.3s ease;
    }

    .nav-link:hover, .nav-link.active {
      color: var(--primary);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px 40px;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 12px;
    }

    h3 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtitle {
      color: var(--text-gray);
      font-size: 1.1rem;
      margin-bottom: 32px;
    }

    .card {
      background: white;
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }

    .card:hover {
      box-shadow: 0 15px 50px rgba(0,0,0,0.1);
    }

    /* Ensure pre tags wrap properly */
    .card pre {
      white-space: pre-wrap !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100%;
    }

    .step-number {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      margin-right: 8px;
    }

    .row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
    .col { flex: 1 1 320px; min-width: 280px; }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      color: var(--dark);
      font-size: 0.95rem;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      font-size: 14px;
      border: 2px solid var(--border);
      border-radius: 12px;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 0, 79, 0.1);
    }

    textarea { min-height: 140px; resize: vertical; }

    button {
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 0, 79, 0.3);
    }

    .btn-secondary {
      background: white;
      border: 2px solid var(--border);
      color: var(--dark);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.success { background: var(--success); color: white; }
    .badge.processing { background: var(--warning); color: white; }
    .badge.failed { background: var(--danger); color: white; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 16px; }
    .muted { color: var(--text-gray); font-size: 0.9rem; }
    .mono { font-family: 'SF Mono', Monaco, 'Inconsolata', 'Fira Code', monospace; }

    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .avatar-item {
      background: white;
      border: 3px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
    }

    .avatar-item:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .avatar-item.selected {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(255,0,79,0.05), rgba(0,242,234,0.05));
    }

    .avatar-item img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .avatar-item .name {
      font-size: 13px;
      font-weight: 600;
      color: var(--dark);
    }

    .video-preview {
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: var(--gray);
      border-radius: 12px;
    }

    .video-preview video {
      max-width: 100%;
      max-height: 400px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .char-count {
      font-size: 12px;
      color: var(--text-gray);
      font-weight: 600;
    }

    .alert-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      color: white;
    }

    .alert-banner h2 {
      margin: 0 0 8px 0;
      font-size: 1.25rem;
    }

    .alert-banner a {
      color: white;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .nav-links { display: none; }
      h1 { font-size: 1.8rem; }
      .card { padding: 20px; }

      .container {
        padding: 0 16px;
      }

      .row {
        flex-direction: column;
      }

      .col {
        min-width: 100%;
        flex: 1 1 100%;
      }

      /* Fix script content overflow on mobile */
      .card div[style*="max-height: 200px"] {
        max-width: 100% !important;
        overflow-x: auto !important;
      }

      /* Ensure script IDs don't overflow */
      .badge.mono {
        font-size: 10px;
        padding: 3px 8px;
        word-break: break-all;
      }

      /* Adjust button layouts for mobile */
      .btn-primary, .btn-secondary, .btn-success {
        padding: 10px 16px;
        font-size: 14px;
      }

      /* Stack pagination buttons on mobile */
      .card div[style*="margin-top: 12px"] button {
        margin: 4px;
      }

      /* Avatar grid responsive */
      .avatar-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
      }

      .avatar-item {
        padding: 12px;
      }

      .avatar-item img {
        height: 100px;
      }

      /* Alert banner mobile */
      .alert-banner {
        padding: 16px;
        border-radius: 12px;
      }

      .alert-banner h2 {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <nav class="nav-header">
    <div class="nav-container">
      <a href="/" class="nav-brand">
        <div class="nav-icon">üé¨</div>
        <span class="nav-title">TikTok Symphony AI</span>
      </a>
      <div class="nav-links">
        <a href="/" class="nav-link">Home</a>
        <a href="/script_generator" class="nav-link">Script Generator</a>
        <a href="/avatar" class="nav-link active">Avatar Videos</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="alert-banner">
      <h2>üé≠ Digital Avatar Videos</h2>
      <p>Transform your scripts into professional videos with AI avatars. <a href="/script_generator">Generate Scripts ‚Üí</a></p>
    </div>

    <h1>Create Avatar Speaking Videos</h1>
    <p class="subtitle">Choose from 80+ professional avatars and bring your scripts to life with AI-powered video generation</p>

    <!-- Step 1: Load Avatars -->
    <div class="card">
      <h3><span class="step-number">1</span> Load Available Avatars</h3>
      <button id="loadAvatarsBtn" class="btn-primary" style="width: auto;">Load Available Avatars</button>
      <p id="loadStatus" class="muted" style="margin-top: 8px;"></p>
    </div>

    <!-- Step 2: Select Avatar -->
    <div id="avatarSection" class="card" style="display: none;">
      <h3><span class="step-number">2</span> Select Digital Avatar</h3>
      <p class="muted">Choose from available avatars. Preview videos show how each avatar looks and speaks.</p>
      <div id="avatarGrid" class="avatar-grid"></div>
      <p id="selectedAvatar" class="muted" style="margin-top: 12px;"></p>
    </div>

    <!-- Step 3: Write Script -->
    <div id="scriptSection" class="card" style="display: none;">
      <h3><span class="step-number">3</span> Select or Write Your Script</h3>

    <!-- Script Selection Options -->
    <div style="margin-bottom: 16px;">
      <label>Choose Script Source:</label>
      <div class="row">
        <button id="useExistingBtn" class="btn-secondary" style="width: auto; margin-right: 8px;">üìö Use Existing Script</button>
        <button id="writeNewBtn" class="btn-primary" style="width: auto;">‚úçÔ∏è Write New Script</button>
      </div>
    </div>

    <!-- Existing Scripts Browser -->
    <div id="existingScriptsSection" style="display: none; margin-top: 16px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
      <h4 style="margin-top: 0;">üîç Select from Your Generated Scripts</h4>

      <!-- Simple navigation -->
      <div class="row" style="margin-bottom: 12px;">
        <div class="col">
          <button id="loadScriptsBtn" class="btn-primary" style="width: auto;">üìù Load My Scripts</button>
        </div>
      </div>

      <!-- Status -->
      <p id="scriptsStatus" class="muted" style="margin-bottom: 16px;"></p>

      <!-- Scripts Results -->
      <div id="scriptsResults" class="grid"></div>
    </div>

    <!-- Manual Script Entry -->
    <div id="manualScriptSection" style="display: none;">
      <label>Script for Avatar to Speak</label>
      <textarea id="avatarScript" placeholder="Enter the text you want the avatar to speak. Maximum 2,000 characters. Avoid emojis and special characters.

Example: 'Hello! Welcome to our amazing product. With our innovative solution, you can achieve incredible results in just minutes. Try it today and see the difference for yourself!'"></textarea>
      <div class="char-count">
        <span id="charCount">0</span> / 2,000 characters
        <span class="muted">(~500 chars = 30-second video)</span>
      </div>
    </div>

    <!-- Selected Script Preview -->
    <div id="selectedScriptPreview" style="display: none; margin-top: 16px; padding: 12px; background: #f0fdf4; border: 1px solid #16a34a; border-radius: 8px;">
      <h4 style="margin-top: 0; color: #16a34a;">‚úÖ Selected Script</h4>
      <div id="selectedScriptContent" style="max-height: 150px; overflow-y: auto; background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
        <pre style="white-space: pre-wrap; margin: 0; font-size: 13px;"></pre>
      </div>
      <div class="char-count">
        <span id="selectedCharCount">0</span> / 2,000 characters
      </div>
      <button id="changeScriptBtn" class="btn-secondary" style="width: auto; margin-top: 8px;">Change Script</button>
    </div>

    <div class="row" style="margin-top: 12px;">
      <div class="col">
        <label>Video Name (Optional)</label>
        <input id="videoName" placeholder="My Avatar Video" />
      </div>
    </div>
    <button id="createVideoBtn" class="btn-success" style="margin-top: 12px; width: auto;">üé¨ Create Speaking Video</button>
    <p id="createStatus" class="muted" style="margin-top: 8px;"></p>
  </div>

  <!-- Step 4: Video Results -->
  <div id="resultsSection" class="card" style="display: none;">
    <h3>üé• Video Generation Results</h3>
    <div id="taskResults"></div>
    <button id="listVideosBtn" class="btn-secondary" style="margin-top: 12px; width: auto;">üìã List All My Avatar Videos</button>
  </div>

  <!-- All Videos -->
  <div id="videosSection" class="card" style="display: none;">
    <h3>üì∫ My Avatar Videos</h3>
    <div id="videosList"></div>
  </div>

  <script>
    const qs = (s) => document.querySelector(s);
    let selectedAvatarId = null;
    let selectedAvatarName = '';
    let selectedScript = '';

    // Script listing variables (copied from script generator)
    const scriptsStatus = qs("#scriptsStatus");
    const scriptsResults = qs("#scriptsResults");
    let currentScriptPage = 1;

    // Variables to store config from backend
    let CONFIG = {
      access_token: '',
      advertiser_id: ''
    };

    // Fetch configuration from backend on page load
    async function fetchConfig() {
      try {
        const response = await fetch('/api/get_config');
        const data = await response.json();
        CONFIG.access_token = data.access_token || '';
        CONFIG.advertiser_id = data.advertiser_id || '';
        console.log('Configuration loaded from backend');

        // Auto-load avatars if access token is available
        if (CONFIG.access_token) {
          loadAvatars();
        }
      } catch (error) {
        console.error('Failed to fetch configuration:', error);
      }
    }

    // Call fetchConfig on page load
    fetchConfig();

    // Character counter for manual entry
    qs("#avatarScript").addEventListener("input", (e) => {
      const count = e.target.value.length;
      qs("#charCount").textContent = count;
      qs("#charCount").style.color = count > 2000 ? '#dc2626' : '#6b7280';
    });

    // Script source selection buttons
    qs("#useExistingBtn").addEventListener("click", () => {
      qs("#existingScriptsSection").style.display = "block";
      qs("#manualScriptSection").style.display = "none";
      qs("#selectedScriptPreview").style.display = "none";
      selectedScript = '';
    });

    qs("#writeNewBtn").addEventListener("click", () => {
      qs("#existingScriptsSection").style.display = "none";
      qs("#manualScriptSection").style.display = "block";
      qs("#selectedScriptPreview").style.display = "none";
      selectedScript = '';
    });

    // Script listing functions (copied exactly from script generator)
    function renderScripts(list, pageInfo = null) {
      scriptsResults.innerHTML = "";

      // Add header with pagination info
      if (pageInfo) {
        const header = document.createElement("div");
        header.className = "card";
        header.style.background = "#f8fafc";
        header.innerHTML = `
          <h2 style="margin: 0 0 8px 0;">üìù Your Generated Scripts</h2>
          <p class="muted" style="margin: 0;">
            Showing ${list.length} of ${pageInfo.total_number} total scripts
            (Page ${pageInfo.page} of ${pageInfo.total_page})
          </p>
          ${pageInfo.total_page > 1 ? `
            <div style="margin-top: 12px;">
              <button id="prevPage" class="btn-secondary" ${pageInfo.page <= 1 ? 'disabled' : ''}>‚Üê Previous</button>
              <span style="margin: 0 12px;">Page ${pageInfo.page} of ${pageInfo.total_page}</span>
              <button id="nextPage" class="btn-secondary" ${pageInfo.page >= pageInfo.total_page ? 'disabled' : ''}>Next ‚Üí</button>
            </div>
          ` : ''}
        `;
        scriptsResults.appendChild(header);
      }

      if (!list || !list.length) {
        const emptyCard = document.createElement("div");
        emptyCard.className = "card";
        emptyCard.innerHTML = "<p class='muted'>No scripts found. Generate some scripts first!</p>";
        scriptsResults.appendChild(emptyCard);
        return;
      }

      list.forEach((s, index) => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.cursor = "pointer";
        card.style.transition = "all 0.3s ease";

        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:center; margin-bottom: 8px; flex-wrap: wrap; gap: 8px;">
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <span class="badge mono">Script #${((pageInfo?.page || 1) - 1) * 20 + index + 1}</span>
              <span class="badge mono">ID: ${s.script_id || "N/A"}</span>
            </div>
            <button class="btn-primary select-script-btn" style="width: auto; white-space: nowrap;">üìã Select Script</button>
          </div>
          <h3 style="margin:0 0 8px 0; color: #111827; word-wrap: break-word;">${s.title || "Generated Script"}</h3>
          <div style="max-height: 200px; overflow-y: auto; overflow-x: hidden; background: #f8fafc; padding: 12px; border-radius: 6px; max-width: 100%;">
            <pre class="mono" style="white-space:pre-wrap; word-wrap:break-word; overflow-wrap:break-word; font-size:13px; margin:0; max-width:100%;">${s.script || "No script content"}</pre>
          </div>
          <div class="muted" style="margin-top: 8px; font-size: 11px; word-wrap: break-word;">
            Characters: ${(s.script || "").length} |
            Created: ${s.create_time || "Unknown"} |
            Updated: ${s.update_time || "Unknown"}
          </div>
        `;

        // Add hover effects
        card.addEventListener('mouseenter', () => {
          card.style.borderColor = '#FF004F';
          card.style.boxShadow = '0 5px 20px rgba(255, 0, 79, 0.1)';
        });

        card.addEventListener('mouseleave', () => {
          card.style.borderColor = '';
          card.style.boxShadow = '';
        });

        // Add script selection functionality
        const selectBtn = card.querySelector('.select-script-btn');
        selectBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          selectScript(s);
        });

        card.addEventListener("click", () => selectScript(s));

        scriptsResults.appendChild(card);
      });

      // Pagination buttons
      const prevBtn = document.getElementById("prevPage");
      const nextBtn = document.getElementById("nextPage");
      if (prevBtn && pageInfo?.page > 1) {
        prevBtn.addEventListener("click", () => loadScriptsPage(pageInfo.page - 1));
      }
      if (nextBtn && pageInfo?.page < pageInfo?.total_page) {
        nextBtn.addEventListener("click", () => loadScriptsPage(pageInfo.page + 1));
      }
    }

    async function loadScripts() {
      loadScriptsPage(1);
    }

    async function loadScriptsPage(page = 1) {
      const access_token = CONFIG.access_token;
      if (!access_token) {
        alert("Access token not configured. Please check environment variables.");
        return;
      }

      currentScriptPage = page;
      scriptsStatus.textContent = `Fetching scripts (page ${page})‚Ä¶`;

      try {
        const r = await fetch(`/api/list_scripts?access_token=${encodeURIComponent(access_token)}&page=${page}&page_size=20`);
        const j = await r.json();

        if (j?.data?.list) {
          renderScripts(j.data.list, j.data.page_info);
          const total = j.data.page_info?.total_number || 0;
          const showing = j.data.list.length;
          scriptsStatus.textContent = `Showing ${showing} of ${total} scripts (page ${page})`;
        } else {
          scriptsStatus.textContent = `Error: ${j?.message || 'Failed to fetch scripts'}`;
          scriptsResults.innerHTML = `<div class="card"><pre class="mono">${JSON.stringify(j, null, 2)}</pre></div>`;
        }
      } catch (error) {
        scriptsStatus.textContent = `Error: ${error.message}`;
        scriptsResults.innerHTML = `<div class="card"><p class="muted">Failed to load scripts. Please check your access token.</p></div>`;
      }
    }

    // Load scripts button handler
    qs("#loadScriptsBtn").addEventListener("click", loadScripts);

    // Script selection
    function selectScript(script) {
      if (!script.script) {
        alert("This script has no content");
        return;
      }

      if (script.script.length > 2000) {
        if (!confirm(`This script is ${script.script.length} characters (max 2000). It will be truncated. Continue?`)) {
          return;
        }
        selectedScript = script.script.substring(0, 2000);
      } else {
        selectedScript = script.script;
      }

      // Show preview
      qs("#existingScriptsSection").style.display = "none";
      qs("#manualScriptSection").style.display = "none";
      qs("#selectedScriptPreview").style.display = "block";

      qs("#selectedScriptContent pre").textContent = selectedScript;
      qs("#selectedCharCount").textContent = selectedScript.length;
      qs("#selectedCharCount").style.color = selectedScript.length > 2000 ? '#dc2626' : '#6b7280';

      // Auto-fill video name if available
      if (script.title && !qs("#videoName").value) {
        qs("#videoName").value = `Avatar - ${script.title}`;
      }
    }

    // Change script button
    qs("#changeScriptBtn").addEventListener("click", () => {
      qs("#selectedScriptPreview").style.display = "none";
      qs("#existingScriptsSection").style.display = "block";
      selectedScript = '';
    });

    // No longer need old pagination handlers - they're built into renderScripts function

    // Load avatars function
    async function loadAvatars() {
      const access_token = CONFIG.access_token;
      if (!access_token) {
        qs("#loadStatus").textContent = "Access token not configured. Please check environment variables.";
        return;
      }

      qs("#loadStatus").textContent = "Loading avatars...";
      if (qs("#loadAvatarsBtn")) qs("#loadAvatarsBtn").disabled = true;

      try {
        const response = await fetch(`/api/get_avatars?access_token=${encodeURIComponent(access_token)}&page_size=100`);
        const data = await response.json();

        if (data.code === 0 && data.data?.list) {
          renderAvatars(data.data.list);
          qs("#avatarSection").style.display = "block";
          qs("#loadStatus").textContent = `Loaded ${data.data.list.length} avatars`;
        } else {
          qs("#loadStatus").textContent = `Error: ${data.message || 'Failed to load avatars'}`;
        }
      } catch (error) {
        qs("#loadStatus").textContent = `Error: ${error.message}`;
      }

      if (qs("#loadAvatarsBtn")) qs("#loadAvatarsBtn").disabled = false;
    }

    // Load avatars button click event
    qs("#loadAvatarsBtn").addEventListener("click", loadAvatars);

    function renderAvatars(avatars) {
      const grid = qs("#avatarGrid");
      grid.innerHTML = "";

      avatars.forEach(avatar => {
        const item = document.createElement("div");
        item.className = "avatar-item";
        item.innerHTML = `
          <img src="${avatar.avatar_thumbnail}" alt="${avatar.avatar_name}" onerror="this.style.display='none'" />
          <div class="name">${avatar.avatar_name}</div>
          <div class="badge mono" style="font-size: 10px; margin-top: 4px;">${avatar.avatar_id}</div>
        `;

        item.addEventListener("click", () => {
          // Remove previous selection
          [...document.querySelectorAll(".avatar-item")].forEach(el => el.classList.remove("selected"));
          // Select this one
          item.classList.add("selected");
          selectedAvatarId = avatar.avatar_id;
          selectedAvatarName = avatar.avatar_name;

          qs("#selectedAvatar").innerHTML = `‚úÖ Selected: <strong>${avatar.avatar_name}</strong> (ID: ${avatar.avatar_id})`;
          qs("#scriptSection").style.display = "block";

          // Auto-scroll to script section
          qs("#scriptSection").scrollIntoView({ behavior: 'smooth' });
        });

        grid.appendChild(item);
      });
    }

    // Create video
    qs("#createVideoBtn").addEventListener("click", async () => {
      const access_token = qs("#accessToken").value.trim();
      let script = '';

      // Get script from either selected or manual entry
      if (selectedScript) {
        script = selectedScript;
      } else if (qs("#manualScriptSection").style.display !== "none") {
        script = qs("#avatarScript").value.trim();
      }

      const videoName = qs("#videoName").value.trim();

      if (!access_token) {
        alert("Please enter your Access-Token");
        return;
      }
      if (!selectedAvatarId) {
        alert("Please select an avatar first");
        return;
      }
      if (!script) {
        alert("Please select a script from your existing scripts or write a new one");
        return;
      }
      if (script.length > 2000) {
        alert("Script is too long. Maximum 2,000 characters allowed.");
        return;
      }

      qs("#createStatus").textContent = "Creating avatar video task...";
      qs("#createVideoBtn").disabled = true;

      const payload = {
        access_token,
        material_packages: [{
          avatar_id: selectedAvatarId,
          script: script,
          ...(videoName && { video_name: videoName })
        }]
      };

      try {
        const response = await fetch("/api/create_avatar_video_task", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await response.json();

        console.log("Create task response:", data); // Debug log

        if (data.code === 0 && data.data?.list?.[0]?.task_id) {
          const taskId = data.data.list[0].task_id;
          qs("#createStatus").innerHTML = `
            <strong>‚úÖ Task created successfully!</strong>
            <br><span class="muted">Task ID: ${taskId}</span>
            <br><span class="muted">Now monitoring progress...</span>
          `;
          qs("#resultsSection").style.display = "block";

          // Small delay before starting polling to ensure task is registered
          setTimeout(() => {
            pollTaskStatus(access_token, taskId);
          }, 1000);
        } else {
          qs("#createStatus").innerHTML = `
            <strong>‚ùå Error creating task</strong>
            <br><span class="muted">${data.message || 'Unknown error'}</span>
            ${data.data?.list?.[0]?.error_msg ? `<br><span class="muted">Details: ${data.data.list[0].error_msg}</span>` : ''}
          `;
        }
      } catch (error) {
        console.error("Create task error:", error);
        qs("#createStatus").innerHTML = `
          <strong>‚ùå Network error</strong>
          <br><span class="muted">${error.message}</span>
        `;
      }

      qs("#createVideoBtn").disabled = false;
    });

    async function pollTaskStatus(access_token, taskId) {
      const maxAttempts = 60; // 5 minutes max
      let attempts = 0;
      let statusMessages = {
        'SUBMITTED': 'üì• Task submitted, waiting to process...',
        'PROCESSING': '‚öôÔ∏è Processing your avatar video...',
        'SUCCESS': '‚úÖ Video generated successfully!',
        'FAILED': '‚ùå Video generation failed'
      };

      const poll = async () => {
        try {
          const response = await fetch(`/api/get_avatar_video_task_status?access_token=${encodeURIComponent(access_token)}&task_ids=${JSON.stringify([taskId])}`);
          const data = await response.json();

          console.log("Poll response:", data); // Debug log

          if (data.code === 0 && data.data?.list?.[0]) {
            const task = data.data.list[0];
            const status = task.status || 'UNKNOWN';

            // Update status with friendly message
            qs("#createStatus").innerHTML = `
              <strong>${statusMessages[status] || `Status: ${status}`}</strong>
              <br><span class="muted">Attempt ${attempts} of ${maxAttempts}</span>
            `;

            if (status === "SUCCESS") {
              renderTaskResult(task, true);
              return true;
            } else if (status === "FAILED") {
              renderTaskResult(task, false);
              return true;
            }
            // Continue polling for SUBMITTED, PROCESSING
          } else {
            // Handle error response
            qs("#createStatus").innerHTML = `
              <strong>‚ö†Ô∏è Checking status...</strong>
              <br><span class="muted">Response: ${data.message || 'Unknown'}</span>
            `;
          }
        } catch (error) {
          console.error("Polling error:", error);
          qs("#createStatus").innerHTML = `
            <strong>‚ö†Ô∏è Network error while checking status</strong>
            <br><span class="muted">${error.message}</span>
          `;
        }
        return false;
      };

      // Initial status
      qs("#createStatus").innerHTML = `
        <strong>üîÑ Starting video generation...</strong>
        <br><span class="muted">This may take 1-3 minutes depending on script length</span>
      `;

      // Poll every 5 seconds
      const pollInterval = setInterval(async () => {
        attempts++;
        const done = await poll();

        if (done || attempts >= maxAttempts) {
          clearInterval(pollInterval);
          if (!done) {
            qs("#createStatus").innerHTML = `
              <strong>‚è±Ô∏è Timeout reached</strong>
              <br><span class="muted">The video may still be processing. Check "List All My Avatar Videos" for results.</span>
            `;
          }
        }
      }, 5000);

      // Initial poll immediately
      await poll();
    }

    function renderTaskResult(task, success) {
      const resultsDiv = qs("#taskResults");

      if (success) {
        const videoName = task.video_name || 'Unnamed Video';
        const videoId = task.avatar_video_id || 'Processing...';
        const previewUrl = task.preview_url || '';

        resultsDiv.innerHTML = `
          <div style="border: 2px solid #16a34a; border-radius: 8px; padding: 16px; background: #f0fdf4;">
            <h4 style="color: #16a34a; margin-top: 0;">‚úÖ Video Generated Successfully!</h4>
            <p><strong>Video Name:</strong> ${videoName}</p>
            <p><strong>Avatar Video ID:</strong> <code>${videoId}</code></p>
            <p><strong>Task Status:</strong> <span class="badge success">SUCCESS</span></p>
            ${previewUrl ? `
              <div class="video-preview">
                <video controls src="${previewUrl}" style="width: 100%; max-width: 600px;">
                  Your browser doesn't support video playback.
                </video>
                <p class="muted">Preview URL expires in 6 hours</p>
              </div>
              <button onclick="copyToClipboard('${previewUrl}')" class="btn-secondary" style="width: auto; margin-top: 12px;">üìã Copy Video URL</button>
              <button onclick="showUploadDialog('${previewUrl}', '${taskId}')" class="btn-success" style="width: auto; margin-top: 12px; margin-left: 8px;">üì§ Upload to TikTok Ads</button>
              <div id="uploadStatus_${taskId}" style="margin-top: 12px;"></div>
            ` : '<p class="muted">Video preview will be available shortly...</p>'}
          </div>
        `;

        // Clear the create status since we have results
        qs("#createStatus").innerHTML = '<strong>‚úÖ Complete!</strong>';
      } else {
        const taskId = task.task_id || 'Unknown';
        const errorMsg = task.error_msg || 'Unknown error occurred';

        resultsDiv.innerHTML = `
          <div style="border: 2px solid #dc2626; border-radius: 8px; padding: 16px; background: #fef2f2;">
            <h4 style="color: #dc2626; margin-top: 0;">‚ùå Video Generation Failed</h4>
            <p><strong>Task ID:</strong> <code>${taskId}</code></p>
            <p><strong>Status:</strong> <span class="badge failed">FAILED</span></p>
            <p><strong>Error:</strong> ${errorMsg}</p>
            <p class="muted">Please try again with a different script or avatar.</p>
          </div>
        `;

        // Update create status
        qs("#createStatus").innerHTML = '<strong>‚ùå Generation failed</strong>';
      }
    }

    // List all videos
    qs("#listVideosBtn").addEventListener("click", async () => {
      const access_token = CONFIG.access_token;
      if (!access_token) {
        alert("Access token not configured. Please check environment variables.");
        return;
      }

      try {
        const response = await fetch(`/api/list_avatar_videos?access_token=${encodeURIComponent(access_token)}&page_size=50`);
        const data = await response.json();

        if (data.code === 0) {
          renderVideosList(data.data?.list || []);
          qs("#videosSection").style.display = "block";
          qs("#videosSection").scrollIntoView({ behavior: 'smooth' });
        } else {
          alert(`Error: ${data.message || 'Failed to load videos'}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    });

    function renderVideosList(videos) {
      const listDiv = qs("#videosList");

      if (!videos.length) {
        listDiv.innerHTML = "<p class='muted'>No avatar videos found.</p>";
        return;
      }

      listDiv.innerHTML = videos.map(video => `
        <div class="card">
          <div class="row" style="align-items: center;">
            <div class="col">
              <h4 style="margin: 0;">${video.video_name}</h4>
              <p class="muted">Created: ${video.create_time}</p>
              <p class="muted">Avatar ID: ${video.avatar_id}</p>
            </div>
            <div style="flex: 0 0 auto;">
              ${video.preview_url ? `<button onclick="playVideo('${video.preview_url}')" class="btn-primary" style="width: auto; margin-right: 8px;">‚ñ∂Ô∏è Play</button>` : ''}
              <button onclick="copyToClipboard('${video.preview_url}')" class="btn-secondary" style="width: auto;">üìã Copy URL</button>
            </div>
          </div>
          ${video.video_cover_url ? `<img src="${video.video_cover_url}" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 6px; margin-top: 12px;" />` : ''}
        </div>
      `).join('');
    }

    // Utility functions
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert("URL copied to clipboard!");
      }).catch(() => {
        prompt("Copy this URL:", text);
      });
    }

    // Show upload dialog
    function showUploadDialog(videoUrl, taskId) {
      const dialog = document.createElement('div');
      dialog.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999;';
      dialog.innerHTML = `
        <div style="background: white; padding: 32px; border-radius: 16px; max-width: 500px; width: 90%;">
          <h3 style="margin-top: 0;">üì§ Upload to TikTok Ads</h3>
          <p class="muted">Upload this avatar video to your TikTok Ads account</p>

          <div style="margin-top: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Advertiser ID</label>
            <input type="text" id="uploadAdvertiserId" placeholder="Your TikTok Ads Advertiser ID" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div style="margin-top: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Video Name (optional)</label>
            <input type="text" id="uploadVideoName" placeholder="e.g., Avatar Video ${taskId}" value="Avatar Video ${taskId}" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
          </div>

          <div id="uploadDialogStatus" style="margin-top: 16px;"></div>

          <div style="margin-top: 20px; display: flex; gap: 12px;">
            <button onclick="performUploadToAds('${videoUrl}', '${taskId}')" class="btn-primary" style="flex: 1;">Upload Now</button>
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" class="btn-secondary" style="flex: 1;">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(dialog);
    }

    // Perform upload to TikTok Ads (Note: Upload endpoints have been removed from backend)
    async function performUploadToAds(videoUrl, taskId) {
      const access_token = CONFIG.access_token;
      const advertiser_id = document.getElementById('uploadAdvertiserId').value.trim();
      const video_name = document.getElementById('uploadVideoName').value.trim();
      const statusDiv = document.getElementById('uploadDialogStatus');

      if (!advertiser_id) {
        statusDiv.innerHTML = '<p style="color: #dc2626;">Please enter your Advertiser ID</p>';
        return;
      }

      statusDiv.innerHTML = '<p style="color: #eab308;">Uploading video to TikTok Ads...</p>';

      try {
        const response = await fetch('/api/upload_video_to_ads', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            access_token,
            advertiser_id,
            video_url: videoUrl,
            video_name: video_name || `Avatar Video ${taskId}`
          })
        });

        const data = await response.json();

        if (data?.data?.video_id || data?.code === "0") {
          statusDiv.innerHTML = '<p style="color: #16a34a;">‚úÖ Successfully uploaded to TikTok Ads!</p>';

          // Also update the main status
          const mainStatus = document.getElementById(`uploadStatus_${taskId}`);
          if (mainStatus) {
            mainStatus.innerHTML = `<p style="color: #16a34a;">‚úÖ Uploaded to TikTok Ads (Video ID: ${data.data?.video_id || 'Success'})</p>`;
          }

          // Close dialog after 2 seconds
          setTimeout(() => {
            document.querySelector('[style*="position: fixed"]')?.remove();
          }, 2000);
        } else {
          statusDiv.innerHTML = `<p style="color: #dc2626;">‚ùå Upload failed: ${data?.message || 'Unknown error'}</p>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<p style="color: #dc2626;">‚ùå Error: ${error.message}</p>`;
      }
    }

    function playVideo(url) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 9999;';
      modal.innerHTML = `
        <div style="position: relative; max-width: 90%; max-height: 90%;">
          <video controls autoplay style="width: 100%; height: 100%;">
            <source src="${url}" type="video/mp4">
          </video>
          <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: -40px; right: 0; background: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï Close</button>
        </div>
      `;
      document.body.appendChild(modal);

      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }
  </script>
  </div>
</body>
</html>